<app-navigation-buttons [backRoute]="'/admin'"></app-navigation-buttons>

<div class="card">
  <h2>2. Determinar la Causa</h2>
  <span class="badge-modo" *ngIf="modoEdicion">ğŸ“ Editando</span>
  <span class="badge-modo nuevo" *ngIf="!modoEdicion">âœ¨ Nuevo</span>

  <!-- InformaciÃ³n del caso -->
  <div class="caso-info" *ngIf="casoActual">
    <h3>ğŸ“‹ InformaciÃ³n del Caso #{{ casoActual.id_caso }}</h3>
    <div class="info-grid">
      <div class="info-item">
        <strong>DescripciÃ³n:</strong>
        <p>{{ casoActual.descripcion }}</p>
      </div>
      <div class="info-item" *ngIf="casoActual.impacto">
        <strong>Impacto:</strong>
        <p>{{ casoActual.impacto }}</p>
      </div>
      <div class="info-item" *ngIf="casoActual.conducta_esperada">
        <strong>Conducta Esperada:</strong>
        <p>{{ casoActual.conducta_esperada }}</p>
      </div>
    </div>
  </div>

  <!-- Mensaje de error general -->
  <div class="alert alert-error" *ngIf="errorMensaje">
    âš ï¸ {{ errorMensaje }}
  </div>

  <form [formGroup]="causaForm" (ngSubmit)="onSubmit()">
    <!-- Causas Identificadas -->
    <div class="form-group">
      <label>Causas Identificadas*</label>
      <textarea 
        formControlName="causasIdentificadas" 
        rows="5" 
        placeholder="Describe las causas que identificaste para este incumplimiento...&#10;&#10;Ejemplo: Falta de capacitaciÃ³n, desconocimiento de las polÃ­ticas, error en el proceso, etc."
        [class.invalid]="causaForm.get('causasIdentificadas')?.invalid && causaForm.get('causasIdentificadas')?.touched">
      </textarea>
      <small *ngIf="causaForm.get('causasIdentificadas')?.hasError('required') && causaForm.get('causasIdentificadas')?.touched" class="error-text">
        Este campo es obligatorio
      </small>
      <small *ngIf="causaForm.get('causasIdentificadas')?.hasError('minlength') && causaForm.get('causasIdentificadas')?.touched" class="error-text">
        Debe tener al menos 10 caracteres
      </small>
    </div>

    <!-- Evidencias (Upload de archivos) -->
    <div class="form-group">
      <label>Evidencias (Opcional)</label>
      <input 
        type="file" 
        id="fileInput"
        (change)="onFileSelect($event)" 
        multiple 
        accept=".jpg,.jpeg,.png,.pdf"
        class="file-input">
      <small class="hint-text">Formatos permitidos: JPG, PNG, PDF (mÃ¡ximo 10MB por archivo)</small>
      
      <!-- Lista de archivos seleccionados -->
      <div class="archivos-lista" *ngIf="archivosSeleccionados.length > 0">
        <h4>Archivos seleccionados ({{ archivosSeleccionados.length }}):</h4>
        <div class="archivo-item" *ngFor="let file of archivosSeleccionados; let i = index">
          <span class="archivo-icon">ğŸ“</span>
          <span class="archivo-nombre">{{ file.name }}</span>
          <span class="archivo-tamano">{{ formatFileSize(file.size) }}</span>
          <button type="button" class="btn-eliminar-archivo" (click)="eliminarArchivo(i)">âœ–</button>
        </div>
      </div>
    </div>

    <!-- Comentarios Adicionales -->
    <div class="form-group">
      <label>Comentarios adicionales</label>
      <textarea 
        formControlName="comentarios" 
        rows="3" 
        placeholder="Notas opcionales, observaciones complementarias...">
      </textarea>
    </div>

    <!-- BotÃ³n de guardar -->
    <button 
      type="submit" 
      class="btn-guardar" 
      [disabled]="isLoading || causaForm.invalid">
      <span *ngIf="!isLoading && !modoEdicion">ğŸ’¾ Guardar Paso 2</span>
      <span *ngIf="!isLoading && modoEdicion">ğŸ’¾ Actualizar Paso 2</span>
      <span *ngIf="isLoading">â³ Guardando...</span>
    </button>
  </form>

  <!-- Botones de flujo -->
  <div class="acciones">
    <button 
      class="btn-continuar" 
      (click)="continuarProceso()" 
      [disabled]="isLoading || !idPaso2Existente"
      title="{{ !idPaso2Existente ? 'Debe guardar el Paso 2 primero' : 'Continuar al paso 3' }}">
      Continuar al paso 3
    </button>
    <button class="btn-terminar" (click)="terminarProceso()" [disabled]="isLoading">
      ğŸ›‘ Terminar Proceso
    </button>
  </div>
</div>

<!-- Card de cierre de proceso -->
<div class="card" *ngIf="mostrarTerminarProceso">
  <h3>JustificaciÃ³n de Cierre</h3>
  <form [formGroup]="cierreForm" (ngSubmit)="enviarCierre()">
    <div class="form-group">
      <label>Motivo de finalizaciÃ³n del proceso*</label>
      <textarea 
        rows="4"
        formControlName="justificacion"
        placeholder="Explique por quÃ© se cierra el proceso en esta etapa sin avanzar a los siguientes pasos...">
      </textarea>
    </div>
    <button type="submit" class="btn-guardar">ğŸ“¤ Enviar JustificaciÃ³n</button>
  </form>
</div>
