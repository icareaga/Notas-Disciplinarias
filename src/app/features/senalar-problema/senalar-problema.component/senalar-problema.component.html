<div class="page-container">
  <!-- Componente de navegaciÃ³n reutilizable con botÃ³n "Regresar" -->
  <app-navigation-buttons></app-navigation-buttons>

  <!-- Mostrar/Ocultar casos existentes (oculto por defecto) -->
  <button
    class="btn-toggle-casos"
    *ngIf="misCasos.length > 0"
    (click)="toggleListaCasos()">
    {{ mostrarListaCasos ? 'Ocultar casos' : ('Ver casos existentes (' + misCasos.length + ')') }}
  </button>
  
  <!-- Tabla de casos existentes -->
  <div class="card casos-lista" *ngIf="mostrarListaCasos && misCasos.length > 0">
    <div class="casos-header">
      <h3>ğŸ“‹ Casos</h3>
      <button class="btn-actualizar" (click)="recargarCasos()" title="Actualizar lista">
        ğŸ”„ Actualizar
      </button>
    </div>
    <table class="casos-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Colaborador</th>
          <th>DescripciÃ³n</th>
          <th>Paso Actual</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let caso of misCasos" (click)="seleccionarCaso(caso)" class="caso-row">
          <td>{{ caso.id_caso }}</td>
          <td>{{ getNombreEmpleado(caso.id_usuario) }}</td>
          <td class="descripcion-cell">{{ caso.descripcion | slice:0:50 }}{{ caso.descripcion.length > 50 ? '...' : '' }}</td>
          <td>
            <span class="badge-paso paso-{{ caso.id_paso || 1 }}">
              Paso {{ caso.id_paso || 1 }}
            </span>
          </td>
          <td>
            <button class="btn-accion" (click)="seleccionarCaso(caso); $event.stopPropagation()">
              {{ caso.id_paso < 6 ? 'â¡ï¸ Avanzar' : 'ğŸ“ Editar' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <div class="card">
    <h2>{{ modoEdicion ? 'ğŸ“ Editar Caso #' + idCasoActual : '1. SeÃ±alar el Problema' }}</h2>
    
    <!-- BotÃ³n cancelar ediciÃ³n -->
    <button *ngIf="modoEdicion" (click)="cancelarEdicion()" class="btn-cancelar">
      âŒ Cancelar EdiciÃ³n
    </button>

  <!-- Campo 1: SelecciÃ³n de colaborador afectado -->
  <!-- Carga dinÃ¡micamente los empleados subordinados del jefe desde la API -->
  <label>Colaborador:</label>
  <select [(ngModel)]="nuevoCaso.idUsuario" [compareWith]="compareNumbers">
    <option [ngValue]="0">Seleccione un colaborador</option>
    <!-- Itera sobre empleados obtenidos de /api/Usuarios/jerarquia/{jefeId} -->
    <option *ngFor="let e of empleados" [ngValue]="e.id">
      {{ e.nombre_Completo }}
    </option>
  </select>

  <!-- Campo 2: Tipo de incumplimiento/falta -->
  <!-- Ejemplos: Retardo, Falta Injustificada, Baja Productividad, etc. -->
  <label>CategorÃ­a:</label>
  <select [(ngModel)]="nuevoCaso.idCategoria" [compareWith]="compareNumbers">
    <option [ngValue]="0">Seleccione una categorÃ­a</option>
    <!-- Itera sobre categorÃ­as obtenidas de /api/Categorias -->
    <!-- getCategoriaId normaliza diferentes formatos de ID del backend -->
    <option *ngFor="let c of categorias" [ngValue]="getCategoriaId(c)">
      {{ c.nombre }}
    </option>
  </select>

  <!-- Campo 3: DescripciÃ³n detallada de QUÃ‰ pasÃ³ -->
  <label>DescripciÃ³n del problema:</label>
  <textarea rows="4" [(ngModel)]="nuevoCaso.descripcion" placeholder="Describe la situaciÃ³n detectada"></textarea>

  <!-- Campo 4: Impacto del incumplimiento en la operaciÃ³n/empresa -->
  <label>Impacto en la empresa:</label>
  <textarea rows="4" [(ngModel)]="nuevoCaso.impacto" placeholder="Â¿CuÃ¡l fue el impacto de esta conducta en la empresa?"></textarea>

  <!-- Campo 5: DescripciÃ³n especÃ­fica de la conducta observada -->
  <label>Conducta observada:</label>
  <textarea rows="4" [(ngModel)]="nuevoCaso.conducta" placeholder="Describe en detalle la conducta que observaste"></textarea>

  <!-- BotÃ³n de guardado: ejecuta validaciones y envÃ­a POST a /api/Casos/crear -->
  <button (click)="crearCaso()">
    {{ modoEdicion ? 'ğŸ’¾ Actualizar Caso' : 'ğŸ’¾ Guardar Caso' }}
  </button>
  </div>
</div>